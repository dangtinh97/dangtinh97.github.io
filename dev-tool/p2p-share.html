<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <title>P2P Share</title>
  <style>
    body {
      background-color: #f5f6fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
      max-width: 900px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 2rem;
      margin-top: 3rem;
    }
    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 2rem;
      font-weight: 600;
    }
    h2 {
      color: #34495e;
      font-size: 1.25rem;
      font-weight: 500;
      margin-bottom: 1rem;
    }
    .form-label {
      font-weight: 500;
      color: #34495e;
      margin-bottom: 0.5rem;
    }
    .form-control {
      border-radius: 5px;
      border: 1px solid #dcdcdc;
      transition: border-color 0.3s;
    }
    .form-control:focus {
      border-color: #3498db;
      box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
    }
    .btn {
      padding: 0.5rem 1.5rem;
      font-weight: 500;
      transition: transform 0.2s, background-color 0.2s;
    }
    .btn:hover {
      transform: translateY(-2px);
    }
    .btn-primary {
      background-color: #3498db;
      border-color: #3498db;
    }
    .btn-outline-info {
      color: #3498db;
      border-color: #3498db;
    }
    .btn-outline-info:hover {
      background-color: #3498db;
      color: white;
    }
    .code-display {
      font-size: 1.25rem;
      text-align: center;
      padding: 0.75rem;
      background: #f8f9fa;
      border-radius: 5px;
      letter-spacing: 2px;
      color: #2c3e50;
      margin-bottom: 2rem;
    }
    .received-content {
      background-color: #f8f9fa;
      border-radius: 5px;
      padding: 1rem;
      color: #2c3e50;
    }
    .file-download {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.5rem;
    }
    img {
      max-width: 100%;
      border-radius: 5px;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Transfer data</h1>

  <div class="code-display" id="myCode">ƒêang t·∫°o m√£...</div>

  <div class="mb-4">
    <label for="peerCode" class="form-label">Nh·∫≠p m√£ c·ªßa ng∆∞·ªùi kh√°c (5 k√Ω t·ª±)</label>
    <input type="text" class="form-control" id="peerCode" placeholder="e.g., ABC12">
    <button class="btn btn-outline-info mt-2" id="btn-connect">K·∫øt n·ªëi</button>
  </div>

  <div class="mb-4">
    <label for="textInput" class="form-label">N·ªôi dung g·ª≠i</label>
    <textarea class="form-control" id="textInput" placeholder="Nh·∫≠p n·ªôi dung ƒë·ªÉ g·ª≠i..." rows="3"></textarea>
    <label for="fileInput" class="form-label mt-2">Ch·ªçn file ho·∫∑c ·∫£nh</label>
    <input type="file" class="form-control" id="fileInput">
    <button class="btn btn-primary mt-2" id="send">G·ª≠i</button>
  </div>

  <div>
    <h2>N·ªôi dung nh·∫≠n ƒë∆∞·ª£c</h2>
    <div class="received-content" id="received">
      <p id="receivedText" class="mb-2"></p>
      <button id="copyBtn" class="btn btn-outline-info mb-2" style="display:none;" onclick="copyText()">Copy</button>
      <img id="receivedImg" style="display:none;">
      <div class="file-download" id="fileDownload" style="display:none;">
        <span id="fileName"></span>
        <button class="btn btn-outline-info" onclick="downloadFile()">T·∫£i</button>
      </div>
    </div>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.js" integrity="sha512-8BHxHDLsOHx+flIrQ0DrZcea7MkHqRU5GbTHmbdzMRnAaoCIkZ97PqZcXJkKZckMMhqfoeaJE+DNUVuyoQsO3Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
<script>
  document.addEventListener("DOMContentLoaded",()=>{
    let myCode = generateCode();
    document.getElementById('myCode').textContent = myCode;
    let peerCode = '';
    let peer = new RTCPeerConnection();
    let dataChannel;
    const socket = io('https://tool.myoupip.com/p2p-connect',{
      transports:['websocket','polling'],
      auth:{
        room_id: myCode
      }
    }); // Thay b·∫±ng server WebSocket c·ªßa b·∫°n
    socket.on('connect',()=>{
      console.log(socket.id)
      socket.on('JOIN',(data)=>{
        $('#btn-connect').attr('disabled',true)
        $('#peerCode').attr('readonly',true)
        if(peerCode===''){
          $('#peerCode').val(data.room_id)
          peerCode = data.room_id
          dataChannel = peer.createDataChannel('chat');
          setupDataChannel(dataChannel);
          peer.createOffer().then(offer => {
            peer.setLocalDescription(offer);
            socket.emit('SIGNALING', {
              room_id: peerCode,
              type: 'offer',
              offer: offer
            });
          });
        }
      })

      socket.on('SIGNALING',(res)=>{
        console.log(res);
        const {type} = res
        if(type==='offer'){
          handlerOffer(res.offer)
        }

        if(type==='answer'){
          handlerAnswer(res.answer)
        }
        if(type==='ice-candidate'){
          handlerCandidate(res.candidate)
        }
      })
    })

    const handlerCandidate = async (candidate)=>{
      try {
        await peer.addIceCandidate(candidate);
      } catch (err) {
        console.error(err);
      }
    }

    const handlerOffer =async (offer)=>{
      await peer.setRemoteDescription(offer);
      peer.ondatachannel = event => setupDataChannel(event.channel);

      const answer = await peer.createAnswer();
      await peer.setLocalDescription(answer);
      socket.emit('SIGNALING', {
        room_id: peerCode,
        type: 'answer',
        answer: answer
      });
    }

    const handlerAnswer =async (answer)=>{
      await peer.setRemoteDescription(answer);
    }

    peer.onicecandidate = event => {
      if (event.candidate) {
        socket.emit('ice-candidate', event.candidate);
        socket.emit('SIGNALING', {
          room_id: peerCode,
          type: 'ice-candidate',
          candidate: event.candidate
        });
      }
    };

    function setupDataChannel(channel) {
      dataChannel = channel;
      dataChannel.onmessage = (event) => {
        const {type,message} = JSON.parse(event.data);
        console.log({type,message})
        if (type === 'text') {
          displayReceivedContent({
            text: message
          })
        }
        // if (data.type === 'text') {
        //   log(`Peer: ${data.message}`);
        // } else if (data.type === 'file') {
        //   const blob = new Blob([new Uint8Array(data.data)]);
        //   const a = document.createElement('a');
        //   a.href = URL.createObjectURL(blob);
        //   a.download = data.filename;
        //   a.textContent = `üì• Download ${data.filename}`;
        //   chatLog.appendChild(a);
        //   chatLog.appendChild(document.createElement('br'));
        // }
      };
    }
    function generateCode() {
      return Math.random().toString(36).substr(2, 5).toUpperCase();
    }

    // ws.onmessage = (event) => {
    //   const data = JSON.parse(event.data);
    //   if (data.type === 'connect' && data.code === myCode) {
    //     peerConnection = data.from;
    //     alert('ƒê√£ k·∫øt n·ªëi v·ªõi ' + peerConnection);
    //   } else if (data.type === 'message' && data.from === peerConnection) {
    //     displayReceivedContent(data.content);
    //   }
    // };
    $('#btn-connect').on('click',()=>{
      peerCode = document.getElementById('peerCode').value.trim().toUpperCase();
      if (peerCode.length !== 5) {
        alert('M√£ ph·∫£i c√≥ 5 k√Ω t·ª±!');
        return;
      }
      socket.emit('JOIN',{
        room_id: peerCode
      })
    })

    $('#send').on('click',()=>{
      const text = document.getElementById('textInput').value.trim();
      if(text!==''){
        dataChannel.send(JSON.stringify({ type: 'text', message: text }));
        document.getElementById('textInput').value = '';
      }
    })

    function sendContent() {
      const text = document.getElementById('textInput').value;
      const file = document.getElementById('fileInput').files[0];
      if (!peerConnection) {
        alert('Ch∆∞a k·∫øt n·ªëi v·ªõi ai!');
        return;
      }

      const content = {};
      if (text) content.text = text;
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          content.file = {
            name: file.name,
            data: reader.result
          };
          ws.send(JSON.stringify({ type: 'message', from: myCode, to: peerConnection, content }));
        };
        if (file.type.startsWith('image/')) {
          reader.readAsDataURL();
        } else {
          reader.readAsDataURL();
        }
      } else {
        ws.send(JSON.stringify({ type: 'message', from: myCode, to: peerConnection, content }));
      }
      document.getElementById('textInput').value = '';
      document.getElementById('fileInput').value = '';
    }

    function displayReceivedContent(content) {
      const receivedText = document.getElementById('receivedText');
      const copyBtn = document.getElementById('copyBtn');
      const receivedImg = document.getElementById('receivedImg');
      const fileDownload = document.getElementById('fileDownload');
      const fileName = document.getElementById('fileName');

      receivedText.textContent = '';
      copyBtn.style.display = 'none';
      receivedImg.style.display = 'none';
      fileDownload.style.display = 'none';

      if (content.text) {
        receivedText.textContent = content.text;
        copyBtn.style.display = 'inline-block';
      }
      if (content.file) {
        if (content.file.data.startsWith('data:image')) {
          receivedImg.src = content.file.data;
          receivedImg.style.display = 'block';
        } else {
          fileName.textContent = content.file.name;
          fileDownload.style.display = 'flex';
          fileDownload.dataset.fileData = content.file.data;
        }
      }
    }

    function copyText() {
      const text = document.getElementById('receivedText').textContent;
      navigator.clipboard.writeText(text);
      alert('ƒê√£ sao ch√©p!');
    }

    function downloadFile() {
      const fileData = document.getElementById('fileDownload').dataset.fileData;
      const link = document.createElement('a');
      link.href = fileData;
      link.download = document.getElementById('fileName').textContent;
      link.click();
    }
  })

</script>
</body>
</html>
