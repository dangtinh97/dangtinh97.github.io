<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <title>Box Voice</title>
  <link rel="stylesheet" href="box-voice.css">
</head>
<body>
<div class="main container-fluid">
  <div class="status mb-2">
    <strong></strong>
    <i id="time-stop"></i>
  </div>
  <div class="language mb-4">
    <label for="lang">
      Languages
    </label><select id="lang" class="form-control">
      <option value="vi-VN">vi-VN</option>
      <option value="en-US">en-US</option>
      <option value="zh-CN">中文 (简体)</option>
    </select>
  </div>
  <div class="input">

  </div>
  <div class="output">
    <pre></pre>
  </div>
  <div class="rec">
    <button class="btn-rec" type="button">REC</button>
    <button class="btn btn-outline-info ms-3" type="button" id="remove-text">RESET</button>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
<script>
  document.addEventListener("DOMContentLoaded",()=>{
    let lang = 'vi-VN'
    let cB = null;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let isStart = false;
    let recognition = null;
    let timeStart = 0;
    $('#lang').on('change',()=>{
      lang = $('#lang').val();
      if(isStart){
        recognition.stop();
      }
    })

    $('#remove-text').on('click',()=>{
      $('.output > pre').html('')
    })
    $('.btn-rec').on('click',()=>{
      if(!recognition){
        return;
      }
      if(!isStart){
        cB = new Date().getTime();
        recognition.lang = lang;
        recognition.start();
      }else {
        recognition.stop();
      }
    })
    if (SpeechRecognition) {
      recognition = new SpeechRecognition();

      // Set properties
      // recognition.lang = lang; // Language for recognition
      recognition.continuous = true; // Recognize speech in a single run
      recognition.interimResults = true; // Only return final results'

      let isProcessing = false;
      // Event handler for results
      recognition.onresult = (event) => {
        if(isProcessing){
          return;
        }
        isProcessing = true;
        let transcript = '';
        // console.log(event);
        for (let i = event.resultIndex; i < event.results.length; i++) {
          if(event.results[i].isFinal){
            //console.log("===>isFinal:"+event.results[i].isFinal)
          }

          transcript += event.results[i][0].transcript;
        }
        console.log(transcript);
        isProcessing = false;
        var preTag = $('.output > pre');
        preTag.append(transcript + ' ')
        preTag.scrollTop(preTag[0].scrollHeight);
        // document.getElementById('result').innerText = `You said: ${transcript}`;
      };

      // Handle errors
      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
      };

      recognition.onstart = ()=>{
        if(cB){
          console.log(`time started: ${new Date().getTime() - cB }`)
        }
        isStart = true;
        timeStart = new Date()
        $('.btn-rec').addClass('is-stop').html('Stop')
        $('.status > strong').html('Starting...')
      }

      // When recognition ends
      recognition.onend = () => {
        recognition.start();
        isStart = false;
        $('.btn-rec').removeClass('is-stop').html('REC')
        console.log(`Stop is: ${Math.round((new Date().getTime() - timeStart.getTime()) / 1000)} (s)`)
        $('.status > strong').html('Speech recognition '+`${Math.round((new Date().getTime() - timeStart.getTime()) / 1000)} (s)`)
        console.log('Speech recognition has stopped.');
      };
    } else {
      console.log('SpeechRecognition API is not supported in this browser.');
    }
  })
</script>
</body>
</html>
